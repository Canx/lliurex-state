<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LliureX - Monitor de Repositorios</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: white;
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 {
            color: #667eea;
            font-size: 3em;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        .status-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .status-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .status-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .status-item.online {
            border-left-color: #10b981;
        }
        .status-item.offline {
            border-left-color: #ef4444;
        }
        .status-item h3 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .status-badge.online {
            background: #d1fae5;
            color: #065f46;
        }
        .status-badge.offline {
            background: #fee2e2;
            color: #991b1b;
        }
        .status-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        .card .version {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .card .stats {
            margin: 20px 0;
        }
        .card .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .card .stat:last-child {
            border-bottom: none;
        }
        .card .stat-label {
            color: #666;
        }
        .card .stat-value {
            font-weight: 600;
            color: #667eea;
        }
        .card .btn {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            transition: opacity 0.3s;
        }
        .card .btn:hover {
            opacity: 0.9;
        }
        footer {
            text-align: center;
            color: white;
            padding: 30px;
            margin-top: 30px;
        }
        footer a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .last-update {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêß LliureX Repository Monitor</h1>
            <p class="subtitle">Monitor de repositorios de paquetes LliureX para Ubuntu</p>
        </header>

        <div class="loading" id="loading">Cargando datos...</div>

        <!-- External Status -->
        <div class="status-section" id="external-status" style="display:none;">
            <h2>üåç Estado Externo (GitHub Actions)</h2>
            <p class="last-update" id="external-timestamp"></p>
            <div class="status-grid" id="external-repos"></div>
        </div>

        <!-- Local Status -->
        <div class="status-section" id="local-status" style="display:none;">
            <h2>üè† Estado Local (Red Aulas)</h2>
            <p class="last-update" id="local-timestamp"></p>
            <div class="status-grid" id="local-repos"></div>
        </div>

        <!-- Package Cards -->
        <div class="cards" id="package-cards"></div>

        <footer>
            <p><strong>LliureX</strong> - Distribuci√≥n Linux educativa de la Generalitat Valenciana</p>
            <p style="margin-top: 10px;">
                <a href="https://lliurex.net" target="_blank">Web oficial</a> ¬∑
                <a href="https://wiki.lliurex.net" target="_blank">Wiki</a> ¬∑
                <a href="https://github.com/Canx/lliurex-state" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, child, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { firebaseConfig } from './firebase_frontend_config.js';

        const VERSIONS = {
            'jammy': { name: 'Ubuntu 22.04 LTS', codename: 'Jammy Jellyfish' },
            'noble': { name: 'Ubuntu 24.04 LTS', codename: 'Noble Numbat' }
        };

        // ... existing format helper functions (formatSize, formatNumber, createStatusItem, createPackageCard) ...
        // I need to copy them here because 'type="module"' creates a module scope, 
        // but the previous script was global. 
        // Ideally I should refactor to keep them, but 'replace' tool is tricky with partial replacements if I change the script tag type.
        
        function formatSize(bytes) {
            if (!bytes) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        function formatNumber(num) {
            return num ? num.toLocaleString('es-ES') : '0';
        }

        function createStatusItem(version, info) {
            const versionInfo = VERSIONS[version];
            const status = info.status === 'online' ? 'online' : 'offline';
            const statusText = status === 'online' ? '‚úì Online' : '‚úó Offline';

            return `
                <div class="status-item ${status}">
                    <h3>${versionInfo.name}</h3>
                    <span class="status-badge ${status}">${statusText}</span>
                    <div class="status-info">
                        <div><strong>Codename:</strong> ${versionInfo.codename}</div>
                        <div><strong>√öltima actualizaci√≥n:</strong> ${info.last_update || 'N/A'}</div>
                    </div>
                </div>
            `;
        }

        function createPackageCard(version, summary) {
            const versionInfo = VERSIONS[version];

            // Don't show card if no real data (offline or empty)
            const components = summary.components || {};
            const totalPackages = Object.values(components).reduce(
                (sum, c) => sum + (c.total_packages || c.package_count || 0), 0);

            // Skip if no packages (offline or no data)
            if (totalPackages === 0 || summary.status === 'offline') {
                return '';
            }

            const status = summary.status || 'unknown';
            const statusText = status === 'online' ? '‚úì Online' : '‚úó Offline';
            const totalSize = Object.values(components).reduce((sum, c) => sum + (c.total_size || 0), 0);
            const totalChanges = Object.values(components).reduce((sum, c) => sum + (c.recent_changes?.length || 0), 0);

            return `
                <div class="card">
                    <span class="status-badge ${status}">${statusText}</span>
                    <h2>${versionInfo.name}</h2>
                    <div class="version">${versionInfo.codename}</div>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-label">üì¶ Paquetes totales</span>
                            <span class="stat-value">${formatNumber(totalPackages)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">üíæ Tama√±o total</span>
                            <span class="stat-value">${formatSize(totalSize)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">üîÑ Cambios recientes</span>
                            <span class="stat-value">${formatNumber(totalChanges)}</span>
                        </div>
                    </div>
                    <a href="${version}.html" class="btn">Ver detalles ‚Üí</a>
                </div>
            `;
        }

        async function loadData() {
            let firebaseApp = null;
            let dbRef = null;

            // Try to initialize Firebase
            if (firebaseConfig && firebaseConfig.databaseURL) {
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    const database = getDatabase(firebaseApp);
                    dbRef = ref(database);
                    console.log("Firebase initialized");
                } catch (e) {
                    console.warn("Firebase initialization failed:", e);
                }
            }

            try {
                // 1. Load External Status
                let external = null;
                if (dbRef) {
                    try {
                        // Get last item from history
                        const historyQuery = query(child(dbRef, 'history'), limitToLast(1));
                        const snapshot = await get(historyQuery);
                        if (snapshot.exists()) {
                            const val = snapshot.val();
                            // val is an object with one key (the push ID)
                            external = Object.values(val)[0];
                        }
                    } catch (e) {
                        console.warn("Firebase history load failed:", e);
                    }
                }
                
                // Fallback to local file
                if (!external) {
                    try {
                        const res = await fetch('history.json');
                        if (res.ok) {
                            const history = await res.json();
                            if (history && history.length > 0) external = history[history.length - 1];
                        }
                    } catch (e) { console.warn("Local history load failed", e); }
                }

                if (external) {
                    document.getElementById('external-timestamp').textContent =
                        `√öltima actualizaci√≥n: ${external.timestamp} UTC`;
                    let externalHTML = '';
                    for (const [version, info] of Object.entries(external.repos)) {
                        externalHTML += createStatusItem(version, info);
                    }
                    document.getElementById('external-repos').innerHTML = externalHTML;
                    document.getElementById('external-status').style.display = 'block';
                }

                // 2. Load Local Status
                let localData = null;
                if (dbRef) {
                    try {
                        const snapshot = await get(child(dbRef, 'local_status'));
                        if (snapshot.exists()) localData = snapshot.val();
                    } catch (e) { console.warn("Firebase local_status load failed", e); }
                }

                if (!localData) {
                    try {
                        const res = await fetch('local_status.json');
                        if (res.ok) {
                            const local = await res.json();
                            localData = Array.isArray(local) ? local[local.length - 1] : local;
                        }
                    } catch (e) { console.warn("Local status load failed", e); }
                }

                if (localData && localData.repos) {
                    document.getElementById('local-timestamp').textContent =
                        `√öltima actualizaci√≥n: ${localData.timestamp} UTC`;
                    let localHTML = '';
                    for (const [version, info] of Object.entries(localData.repos)) {
                        localHTML += createStatusItem(version, info);
                    }
                    document.getElementById('local-repos').innerHTML = localHTML;
                    document.getElementById('local-status').style.display = 'block';
                }

                // 3. Load Package State
                let packagesState = null;
                if (dbRef) {
                    try {
                        const snapshot = await get(child(dbRef, 'packages_state'));
                        if (snapshot.exists()) packagesState = snapshot.val();
                    } catch (e) { console.warn("Firebase packages_state load failed", e); }
                }

                if (!packagesState) {
                    try {
                        const res = await fetch('packages_state.json');
                        if (res.ok) packagesState = await res.json();
                    } catch (e) { console.warn("Local packages_state load failed", e); }
                }

                if (packagesState) {
                    let cardsHTML = '';
                    for (const version of ['jammy', 'noble']) {
                        if (packagesState[version]) {
                            cardsHTML += createPackageCard(version, packagesState[version]);
                        }
                    }
                    if (cardsHTML) {
                        document.getElementById('package-cards').innerHTML = cardsHTML;
                    }
                } else {
                     document.getElementById('package-cards').innerHTML = `
                        <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                            <p style="color: #666; font-size: 1.1em;">
                                üì¶ La informaci√≥n detallada de paquetes se actualizar√° semanalmente.
                            </p>
                        </div>`;
                }

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML =
                    '<div class="error">Error al cargar los datos</div>';
            }
        }

        // Load data when page loads
        loadData();
    </script>
</body>
</html>
